<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Street Lighting Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-search@3.0.7/dist/leaflet-search.min.css" />

  <style>
    body { margin:0; padding:0; }
    #map { width: 100%; height: 100vh; }
  </style>
</head>
<body>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-control-search@3.0.7/dist/leaflet-search.min.js"></script>

<script>
// Initialise map (centre roughly on York)
var map = L.map('map').setView([53.96, -1.08], 13);

// Add OpenStreetMap tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Cluster group for performance
var markers = L.markerClusterGroup();

// Load the GeoJSON
fetch("Street_lighting.geojson")
  .then(res => res.json())
  .then(data => {
    var geojsonLayer = L.geoJson(data, {
      onEachFeature: function (feature, layer) {
        // Use LP_UNIQUE_REF as main ID, fallback to IIT_NE_ID
        var id = feature.properties.LP_UNIQUE_REF || feature.properties.IIT_NE_ID || "Unknown";
        var desc = feature.properties.DESCRIPTION || "";
        var road = feature.properties.ROAD_NAME || "";
        
        // Google Form link (replace with your own form + entry ID)
        var formLink = "https://docs.google.com/forms/d/e/1FAIpQLSf5Q35Lody4pbcu9SKh3jxh3R5qqqLNajV6gzQgci6PZRB7Dg/viewform?usp=pp_url&entry.1636359810=" 
                        + encodeURIComponent(id);
        
        var popupContent = "<b>Streetlight Ref:</b> " + id + "<br>" +
                           "<b>Description:</b> " + desc + "<br>" +
                           "<b>Road:</b> " + road + "<br>" +
                           "<a href='" + formLink + "' target='_blank'>Report a problem</a>";
        
        layer.bindPopup(popupContent);
      }
    });

    // Add clustered layer to map
    markers.addLayer(geojsonLayer);
    map.addLayer(markers);

    // Add search control (search by LP_UNIQUE_REF)
    var searchControl = new L.Control.Search({
      layer: geojsonLayer,
      propertyName: 'LP_UNIQUE_REF',
      initial: false,
      zoom: 17,
      marker: false
    });
    map.addControl(searchControl);
  });
</script>
</body>
</html>

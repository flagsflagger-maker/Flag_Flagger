<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Street Lighting Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-search@3.0.7/dist/leaflet-search.min.css" />

<style>
  body { margin:0; padding:0; }
  #map { width:100%; height:100vh; }
  #reported-counter {
    position:absolute;
    top:10px;
    right:10px;
    z-index:1000;
    background:white;
    padding:6px 12px;
    border-radius:4px;
    font-weight:bold;
    box-shadow:0 0 6px rgba(0,0,0,0.3);
    font-family:sans-serif;
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="reported-counter">Reported Flags: 0</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-control-search@3.0.7/dist/leaflet-search.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
var map = L.map('map').setView([53.96, -1.08], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

var reportLayer = L.markerClusterGroup();
var reportedFlagsLayer = L.layerGroup();

const GEOJSON_URL = "Street_lighting.geojson";
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH2VV-FfOWWKyr4XRaVAPxWL-8zn2dKmYB_2XxxKG_b9IfJVtgGU5xcFje_wh7WW_AyGpDABQpMlFo/pub?gid=27103071&single=true&output=csv';

// --- Load GeoJSON ---
fetch(GEOJSON_URL)
.then(res => res.json())
.then(data => {

  // --- Report a flag layer ---
  var geojsonReport = L.geoJson(data, {
    onEachFeature: function(feature, layer) {
      var id = feature.properties.LP_UNIQUE_REF || feature.properties.IIT_NE_ID || "Unknown";
      var desc = feature.properties.DESCRIPTION || "";
      var road = feature.properties.ROAD_NAME || "";
      var formLink = "https://docs.google.com/forms/d/e/1FAIpQLSf5Q35Lody4pbcu9SKh3jxh3R5qqqLNajV6gzQgci6PZRB7Dg/viewform?usp=pp_url&entry.1636359810=" + encodeURIComponent(id);
      var popupContent = "<b>Streetlight Ref:</b> " + id + "<br><b>Description:</b> " + desc + "<br><b>Road:</b> " + road + "<br><a href='" + formLink + "' target='_blank'>Report a problem</a>";
      layer.bindPopup(popupContent);
    }
  });
  reportLayer.addLayer(geojsonReport);

  // Search
  var searchControl = new L.Control.Search({ layer: geojsonReport, propertyName: 'LP_UNIQUE_REF', initial: false, zoom:17, marker:false });
  map.addControl(searchControl);

  // --- Reported Flags layer ---
  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      const reported = results.data.filter(r => r.LP_UNIQUE_REF);

      // Build GeoJSON lookup
      const geoLookup = {};
      data.features.forEach(f => {
        const id = f.properties.LP_UNIQUE_REF || f.properties.IIT_NE_ID;
        if(id) geoLookup[id] = f.geometry.coordinates;
      });

      reported.forEach(r => {
        const id = r.LP_UNIQUE_REF;
        const issue = r.Issue_Description || '';
        const coords = geoLookup[id];
        if(!coords) return;

        let severity = 'Low';
        if(issue.toLowerCase().includes('med')) severity = 'Med';
        else if(issue.toLowerCase().includes('high')) severity = 'High';
        let color = severity==='Low'?'green':severity==='Med'?'orange':'red';

        const marker = L.circleMarker([coords[1], coords[0]], {radius:8, fillColor:color, color:'#000', weight:1, opacity:1, fillOpacity:0.8})
          .bindPopup("<b>Streetlight Ref:</b> "+id+"<br><b>Issue:</b> "+issue);
        reportedFlagsLayer.addLayer(marker);
      });

      // --- Layer toggle using overlays ---
      var overlays = {
        "Report a flag": reportLayer,
        "Reported Flags": reportedFlagsLayer
      };

      var layerControl = L.control.layers({}, overlays, {collapsed:false}).addTo(map);

      // Add only reportLayer by default
      reportLayer.addTo(map);
      updateCounter(reportLayer);

      // Listen for overlayadd/remove events to enforce one layer visible
      map.on('overlayadd', function(e){
        if(e.name==="Report a flag") { map.removeLayer(reportedFlagsLayer); updateCounter(reportLayer); }
        if(e.name==="Reported Flags") { map.removeLayer(reportLayer); updateCounter(reportedFlagsLayer); }
      });
      map.on('overlayremove', function(e){
        // Ensure at least one layer is visible
        if(!map.hasLayer(reportLayer) && !map.hasLayer(reportedFlagsLayer)){
          reportLayer.addTo(map);
          updateCounter(reportLayer);
        }
      });

      function updateCounter(layer){
        if(layer===reportedFlagsLayer) document.getElementById('reported-counter').textContent = "Reported Flags: "+reported.length;
        else document.getElementById('reported-counter').textContent = "Reported Flags: 0";
      }

    },
    error: function(err){ console.error("CSV parse error:", err);}
  });

});
</script>
</body>
</html>

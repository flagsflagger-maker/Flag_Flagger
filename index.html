<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Street Lighting Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { margin:0; padding:0; }
#map { width:100%; height:100vh; position:relative; }
.custom-control {
  position:absolute;
  top:10px;
  left:10px;
  z-index:1000;
  background:white;
  padding:5px 10px;
  border-radius:4px;
  font-family:sans-serif;
}
#reported-counter {
  position:absolute;
  top:10px;
  right:10px;
  z-index:1000;
  background:white;
  padding:6px 12px;
  border-radius:4px;
  font-weight:bold;
  box-shadow:0 0 6px rgba(0,0,0,0.3);
  font-family:sans-serif;
}
#report-text {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%);
  font-size:24px;
  font-weight:bold;
  background:white;
  padding:10px 20px;
  border-radius:6px;
  box-shadow:0 0 8px rgba(0,0,0,0.3);
  display:none;
  z-index:999;
}
</style>
</head>
<body>
<div id="map"></div>
<div id="report-text">Report an issue</div>
<div class="custom-control">
  <select id="layer-toggle">
    <option value="report">Report</option>
    <option value="reported">Reported</option>
  </select>
</div>
<div id="reported-counter">Reported Flags: 0</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
var map = L.map('map').setView([53.96, -1.08], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

var reportLayer = L.layerGroup(); // dummy layer for Report overlay
var reportedLayer = L.layerGroup();

const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH2VV-FfOWWKyr4XRaVAPxWL-8zn2dKmYB_2XxxKG_b9IfJVtgGU5xcFje_wh7WW_AyGpDABQpMlFo/pub?gid=27103071&single=true&output=csv';
const GEOJSON_URL = "Street_lighting.geojson";
const reportTextDiv = document.getElementById('report-text');

// --- Load GeoJSON coordinates only for reported markers ---
fetch(GEOJSON_URL)
.then(res=>res.json())
.then(geojsonData => {
  const geoLookup = {};
  geojsonData.features.forEach(f=>{
    const id = f.properties.LP_UNIQUE_REF || f.properties.IIT_NE_ID;
    if(id) geoLookup[id] = f.geometry.coordinates; // [lng,lat]
  });

  // --- Load CSV for Reported overlay ---
  Papa.parse(CSV_URL, {
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:function(results){
      const reported = results.data.filter(r => r.LP_UNIQUE_REF);
      document.getElementById('reported-counter').textContent = "Reported Flags: "+reported.length;

      reported.forEach(r=>{
        const id = r.LP_UNIQUE_REF;
        const issue = r.Issue_Description || '';
        const coords = geoLookup[id];
        if(!coords) return;

        let severity = 'Low';
        if(issue.toLowerCase().includes('med')) severity = 'Med';
        else if(issue.toLowerCase().includes('high')) severity = 'High';
        let color = severity==='Low'?'green':severity==='Med'?'orange':'red';

        const marker = L.circleMarker([coords[1], coords[0]], {radius:8, fillColor:color, color:'#000', weight:1, opacity:1, fillOpacity:0.8})
          .bindPopup("<b>Streetlight Ref:</b>"+id+"<br><b>Issue:</b>"+issue);

        reportedLayer.addLayer(marker);
      });

      // Show default layer (Report)
      map.addLayer(reportLayer);
      reportTextDiv.style.display = 'block';
    },
    error:function(err){console.error("CSV parse error:",err);}
  });
});

// --- Dropdown toggle ---
document.getElementById('layer-toggle').addEventListener('change', function(){
  const val = this.value;
  if(val==='report'){
    if(map.hasLayer(reportedLayer)) map.removeLayer(reportedLayer);
    map.addLayer(reportLayer);
    reportTextDiv.style.display = 'block';
  }
  if(val==='reported'){
    if(map.hasLayer(reportLayer)) map.removeLayer(reportLayer);
    map.addLayer(reportedLayer);
    reportTextDiv.style.display = 'none';
  }
});
</script>
</body>
</html>

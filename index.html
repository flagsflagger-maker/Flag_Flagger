<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Street Lighting Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
body { margin:0; padding:0; }
#map { width:100%; height:100vh; }
.custom-control {
  position:absolute;
  top:40px;
  right:10px;
  z-index:1000;
  background:white;
  padding:5px 10px;
  border-radius:4px;
  font-family:sans-serif;
}
#reported-counter {
  position:absolute;
  top:10px;
  right:10px;
  z-index:1000;
  background:white;
  padding:6px 12px;
  border-radius:4px;
  font-weight:bold;
  box-shadow:0 0 6px rgba(0,0,0,0.3);
  font-family:sans-serif;
}
</style>
</head>
<body>
<div id="map"></div>
<div class="custom-control">
  <select id="layer-toggle">
    <option value="report">Report</option>
    <option value="reported">Reported</option>
  </select>
</div>
<div id="reported-counter">Reported Flags: 0</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
const map = L.map('map').setView([53.96, -1.08], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

const reportLayer = L.markerClusterGroup();
const reportedLayer = L.layerGroup();

const GEOJSON_URL = "Street_lighting.geojson";
const REPORTS_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH2VV-FfOWWKyr4XRaVAPxWL-8zn2dKmYB_2XxxKG_b9IfJVtgGU5xcFje_wh7WW_AyGpDABQpMlFo/pub?gid=27103071&single=true&output=csv';
const FLAGS_CSV   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTQ8KXvsECao-1KLnmp9SC9kO3mTjj0a9rBmNkqNHeFTNkXDW9FvrCSeML6gdnbRp2_PhqaFAim-so9/pub?gid=0&single=true&output=csv';
const APPSCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwik4Hxlp6Va_VZZDEi_V_NAU7aSdHUuI21bqSEh1u4bfjM9l7WbqaLrusXlXBdAro6/exec';

let geoLookup = {};

// --- Load GeoJSON for Report overlay ---
fetch(GEOJSON_URL).then(res=>res.json()).then(geojsonData=>{
  geojsonData.features.forEach(f=>{
    const id = f.properties.LP_UNIQUE_REF || f.properties.IIT_NE_ID;
    if(id) geoLookup[id] = f.geometry.coordinates;

    const desc = f.properties.DESCRIPTION || "";
    const road = f.properties.ROAD_NAME || "";
    const ward = f.properties.WARD || "";
    const loc = f.properties.LOCATION || "";

    const marker = L.marker([f.geometry.coordinates[1], f.geometry.coordinates[0]]);
    marker.bindPopup(`
      <b>Streetlight Ref:</b> ${id}<br>
      <b>Description:</b> ${desc}<br>
      <b>Road:</b> ${road}<br>
      <b>Ward:</b> ${ward}<br>
      <button class="report-btn" 
              data-id="${id}" 
              data-loc="${loc}" 
              data-road="${road}" 
              data-ward="${ward}">Report a problem</button>
    `);
    reportLayer.addLayer(marker);
  });

  map.addLayer(reportLayer);
});

// --- Load Reported overlay ---
function loadReportedLayer(){
  reportedLayer.clearLayers();
  Promise.all([
    new Promise(resolve=>Papa.parse(REPORTS_CSV,{download:true,header:true,skipEmptyLines:true,complete:r=>resolve(r.data)})),
    new Promise(resolve=>Papa.parse(FLAGS_CSV,{download:true,header:true,skipEmptyLines:true,complete:r=>resolve(r.data)}))
  ]).then(([reports,flags])=>{
    const flaggedSet = new Set(flags.map(f=>f.LP_UNIQUE_REF));
    const filtered = reports.filter(r=>r.LP_UNIQUE_REF && !flaggedSet.has(r.LP_UNIQUE_REF));
    document.getElementById('reported-counter').textContent = "Reported Flags: "+filtered.length;

    filtered.forEach(r=>{
      const id = r.LP_UNIQUE_REF;
      const issue = r.Issue_Description || '';
      const timestamp = r.Timestamp || '';
      const coords = geoLookup[id];
      if(!coords) return;

      let severity = 'Low';
      if(issue.toLowerCase().includes('med')) severity='Med';
      else if(issue.toLowerCase().includes('high')) severity='High';
      let color = severity==='Low'?'green':severity==='Med'?'orange':'red';

      const marker = L.circleMarker([coords[1], coords[0]],{
        radius:8, fillColor:color, color:'#000', weight:1, opacity:1, fillOpacity:0.8
      });

      marker.bindPopup(`
        <b>Streetlight Ref:</b> ${id}<br>
        <b>Issue:</b> ${issue}<br>
        <b>Location:</b> ${r.LOCATION}<br>
        <b>Road_Name:</b> ${r.ROAD_NAME}<br>
        <b>Ward:</b> ${r.WARD}<br>
        <b>Timestamp:</b> ${timestamp}<br>
        <button class="flag-btn" data-id="${id}">Flag for Removal</button>
      `);

      reportedLayer.addLayer(marker);
    });
  });
}

// Initial load
loadReportedLayer();

// Refresh reported overlay every 60s if visible
setInterval(()=>{
  if(document.getElementById('layer-toggle').value==='reported'){
    loadReportedLayer();
  }
},60000);

// --- Dropdown toggle ---
document.getElementById('layer-toggle').addEventListener('change',function(){
  const val = this.value;
  if(val==='report'){
    if(map.hasLayer(reportedLayer)) map.removeLayer(reportedLayer);
    map.addLayer(reportLayer);
  } else if(val==='reported'){
    if(map.hasLayer(reportLayer)) map.removeLayer(reportLayer);
    loadReportedLayer();
    map.addLayer(reportedLayer);
  }
});

// --- Event delegation for buttons ---
map.getContainer().addEventListener('click', function(e){
  const target = e.target;

  if(target.classList.contains('report-btn')){
    const id = target.dataset.id;
    const loc = target.dataset.loc;
    const road = target.dataset.road;
    const ward = target.dataset.ward;
    const url = `${APPSCRIPT_URL}?LP_UNIQUE_REF=${encodeURIComponent(id)}&LOCATION=${encodeURIComponent(loc)}&ROAD_NAME=${encodeURIComponent(road)}&WARD=${encodeURIComponent(ward)}&Issue_Description=Reported`;

    fetch(url, { method: 'GET' })
      .then(res => alert('Report submitted!'))
      .catch(err => alert('Error submitting report'));
  }

  if(target.classList.contains('flag-btn')){
    const id = target.dataset.id;
    fetch(`${APPSCRIPT_URL}?LP_UNIQUE_REF=${encodeURIComponent(id)}`, { method:'GET' })
      .then(res => {
        alert('Flag submitted!');
        // Remove marker visually
        const marker = target.closest('.leaflet-popup')._source;
        if(marker) map.removeLayer(marker);
      })
      .catch(err => alert('Error submitting flag'));
  }
});
</script>
</body>
</html>

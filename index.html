<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Street Lighting Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-search@3.0.7/dist/leaflet-search.min.css" />

  <style>
    body { margin:0; padding:0; }
    #map { width: 100%; height: 100vh; }

    .marker-cluster.reported {
      background-color: rgba(255, 0, 0, 0.6);
      color: white;
      border: 2px solid red;
    }

    /* Counter box for reported flags */
    #reported-counter {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-family: sans-serif;
      font-weight: bold;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
<div id="map"></div>
<div id="reported-counter">Reported Flags: 0</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-control-search@3.0.7/dist/leaflet-search.min.js"></script>

<!-- Tabletop.js for Google Sheet -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.6.0/tabletop.min.js"></script>

<script>
  var map = L.map('map').setView([53.96, -1.08], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const SHEET_ID = '1Puy_K1qEi4DqX5mdWh4UbJPI-H-QbJbSuexkuobUT6c';

  // Cluster layer for all streetlights
  var markers = L.markerClusterGroup({
    iconCreateFunction: function(cluster) {
      var reportedCount = 0;
      cluster.getAllChildMarkers().forEach(marker => {
        if (marker.options.isReported) reportedCount++;
      });
      var html = reportedCount > 0 ? reportedCount : cluster.getChildCount();
      var className = reportedCount > 0 ? 'marker-cluster reported' : 'marker-cluster';
      return L.divIcon({ html: html, className: className, iconSize: L.point(40, 40) });
    }
  });

  // Layer for reported flags (no clustering)
  var reportedFlags = L.layerGroup();

  // Add GeoJSON streetlights
  fetch("Street_lighting.geojson")
    .then(res => res.json())
    .then(data => {
      var geojsonLayer = L.geoJson(data, {
        onEachFeature: function(feature, layer) {
          var id = feature.properties.LP_UNIQUE_REF || feature.properties.IIT_NE_ID || "Unknown";
          var desc = feature.properties.DESCRIPTION || "";
          var road = feature.properties.ROAD_NAME || "";
          var formLink = "https://docs.google.com/forms/d/e/1FAIpQLSf5Q35Lody4pbcu9SKh3jxh3R5qqqLNajV6gzQgci6PZRB7Dg/viewform?usp=pp_url&entry.1636359810=" + encodeURIComponent(id);
          var popupContent = "<b>Streetlight Ref:</b> " + id + "<br>" +
                             "<b>Description:</b> " + desc + "<br>" +
                             "<b>Road:</b> " + road + "<br>" +
                             "<a href='" + formLink + "' target='_blank'>Report a problem</a>";
          layer.bindPopup(popupContent);
        }
      });

      markers.addLayer(geojsonLayer);
      map.addLayer(markers);

      var searchControl = new L.Control.Search({
        layer: geojsonLayer,
        propertyName: 'LP_UNIQUE_REF',
        initial: false,
        zoom: 17,
        marker: false
      });
      map.addControl(searchControl);

      // Layer control
      var baseMaps = { "Report a problem": markers };
      var overlayMaps = { "Reported Flags": reportedFlags };
      L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);

      // Initial load & periodic refresh of reported flags
      function refreshReports() {
        reportedFlags.clearLayers();

        Tabletop.init({
          key: SHEET_ID,
          simpleSheet: true,
          callback: function(data) {
            // Update counter
            document.getElementById('reported-counter').textContent = "Reported Flags: " + data.length;

            data.forEach(row => {
              const id = row['LP_UNIQUE_REF'];
              const issue = row['Issue_Description'] || 'Reported issue';
              const severity = row['Severity'] || 'Low';

              geojsonLayer.eachLayer(layer => {
                const layerId = layer.feature.properties.LP_UNIQUE_REF || layer.feature.properties.IIT_NE_ID;
                if (layerId === id) {
                  // Update cluster popup
                  let popupContent = layer.getPopup().getContent();
                  if(!popupContent.includes(issue)) {
                    popupContent += '<br><b>Reported Issue:</b> ' + issue + '<br><b>Severity:</b> ' + severity;
                    layer.bindPopup(popupContent);
                  }

                  layer.setIcon(L.icon({
                    iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-red.png',
                    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                  }));
                  layer.options.isReported = true;

                  // Add colored marker for reported flags
                  let color;
                  if (severity.toLowerCase() === 'low') color = 'green';
                  else if (severity.toLowerCase() === 'med' || severity.toLowerCase() === 'medium') color = 'orange';
                  else color = 'red';

                  var latlng = layer.getLatLng();
                  var reportedMarker = L.circleMarker(latlng, {
                    radius: 8,
                    fillColor: color,
                    color: '#000',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                  }).bindPopup("<b>Streetlight Ref:</b> " + id + "<br><b>Issue:</b> " + issue + "<br><b>Severity:</b> " + severity);

                  reportedFlags.addLayer(reportedMarker);
                }
              });
            });
          }
        });
      }

      refreshReports();
      setInterval(refreshReports, 60000); // refresh every 60s
    });
</script>
</body>
</html>
